#!/bin/bash

# Argument = -i ip-address -d dockerfile -p port

usage()
{
  cat << EOF
usage: $0 options

This script deploys dockerfile code to IP address and port.

OPTIONS:
  -i      IP Address
  -d      Dockerfile Location
  -p      Port
EOF
}

IP=
DOCKER_FILE_LOCATION=
PORT=

while getopts i:d:p: OPTION; do
  case $OPTION in
    i)
      IP=$OPTARG
      ;;
    d)
      DOCKER_FILE_LOCATION=$OPTARG
      ;;
    p)
      PORT=$OPTARG
      ;;
    ?)
      usage
      exit
      ;;
   esac
done

echo "IP" = $IP
echo "DOCKER_FILE_LOCATION" = $DOCKER_FILE_LOCATION
echo "PORT" = $PORT

if [[ -z $IP ]] || [[ -z $DOCKER_FILE_LOCATION ]] || [[ -z $PORT ]]
then
  usage
  exit 1
fi

MACHINE_NAME=$IP-machine
IMAGE_NAME=$IP`echo ${DOCKER_FILE_LOCATION} | tr '[:upper:]' '[:lower:]' | sed "s/\//_/g"`

docker-machine create  --driver generic --generic-ip-address $IP $MACHINE_NAME
eval "$(docker-machine env $MACHINE_NAME)"
docker build --rm -t $IMAGE_NAME $DOCKER_FILE_LOCATION
docker run -d -p $PORT:80 $IMAGE_NAME